# Design: 增强 /new 指令目录选择卡片

## 问题分析

飞书 Card 2.0 的 `select_static` 是纯静态组件，选项在卡片构建时写死，不支持：
- 用户输入时动态搜索/加载选项
- on_search / on_input 事件回调
- autocomplete / combobox 类型组件

因此需要组合多个组件来实现"选择 + 自定义输入 + 目录浏览"的体验。

## 方案设计

### 卡片 UI 布局

```
┌──────────────────────────────────────────┐
│  🧠 完善信息以创建会话                      │
├──────────────────────────────────────────┤
│  请选择工作目录并输入您的问题：              │
│  ────────────────────────────────────     │
│                                          │
│  [Form]                                  │
│    常用目录:                              │
│    [▼ 选择工作目录                    ]   │
│                                          │
│    自定义路径:                            │
│    ┌──────────────────────┬──────────┐   │
│    │ [/home/user/project] │ [浏览]   │   │
│    └──────────────────────┴──────────┘   │
│    💡 优先使用自定义路径；留空则使用常用目录  │
│                                          │
│    您的问题:                              │
│    [请输入您的问题或任务描述            ]   │
│                                          │
│              [创建会话]                   │
│                                          │
└──────────────────────────────────────────┘
```

**布局特点**：
- 使用飞书 `column_set` 容器将自定义路径输入框与浏览按钮并排显示
- 输入框占据主要宽度（`width: weighted`）
- 浏览按钮紧凑显示（`width: auto`），按钮文字简化为"浏览"
- 创建会话按钮独占一行（全宽）作为主要操作

### 目录确定优先级

提交表单时，目录确定的优先级为：

1. **自定义路径输入框** (`custom_dir`) — 如果非空，使用此值
2. **常用目录下拉菜单** (`directory`) — 如果 custom_dir 为空，使用此值
3. 两者都为空 → 返回 toast 错误提示

### 路径浏览交互流程

```
用户点击 [浏览] 按钮（与自定义路径输入框并排）
    │
    ├─ 如果 custom_dir 有值 → 列出 custom_dir 下的子目录
    ├─ 如果 custom_dir 为空 → 列出默认起始路径 (/) 下的子目录
    │
    ▼
卡片整体更新: custom_dir 回填当前路径，下方显示子目录列表
    │
    ├─ 用户从"浏览结果"下拉菜单选择某个子目录
    │  └─ 下一次点击 [浏览] 时基于该路径继续深入
    ├─ 用户继续点击 [浏览] → 逐级导航
    └─ 用户点击 [创建会话] → 提交
```

**浏览后卡片布局变化**：
- custom_dir 输入框回填当前浏览路径（如 `/home/user`）
- 输入框下方新增"浏览结果"下拉菜单，显示该路径下的子目录
- 用户可以继续点击 [浏览] 深入，或直接从浏览结果选择

**重要**: 由于飞书卡片不支持"无操作时的实时回调"，路径浏览采用**按钮触发 + 卡片整体更新**模式。每次点击"浏览目录"按钮，服务端返回一个全新的卡片（包含当前目录的子目录列表），飞书自动替换原卡片。

### 后端接口设计

#### `/claude/browse-dirs` (POST)

**请求：**
```json
{
  "path": "/home/user",
  "limit": 20
}
```

**响应：**
```json
{
  "dirs": [
    "/home/user/project1",
    "/home/user/project2",
    "/home/user/documents"
  ],
  "parent": "/home",
  "current": "/home/user"
}
```

**安全限制：**
- 只列出目录，不列出文件
- 过滤隐藏目录（以 `.` 开头的目录）
- 限制最大返回数量（默认 20）
- path 必须是绝对路径
- path 必须存在且可访问

### 回调处理设计

卡片中的两个按钮走不同的回调路径：

| 按钮 | form_action_type | 回调处理 |
|------|-----------------|---------|
| 浏览（与输入框并排） | `submit` | 识别 `browse_btn` 按钮名 → 获取 custom_dir → 调用 browse-dirs → 返回更新后的卡片 |
| 创建会话（全宽主按钮） | `submit` | 识别 `submit_btn` 按钮名 → 获取 custom_dir 或 directory → 创建会话 |

**区分按钮**：飞书 Form 表单提交时，回调数据中包含触发按钮的 `name`，通过判断按钮 name 来区分"浏览"和"创建"操作。

### 状态保持

浏览目录时卡片会整体更新，需要保持以下状态：
- `prompt` 输入框的值 → 通过 `default_value` 回填
- `custom_dir` 输入框的值 → 通过 `default_value` 回填为当前浏览路径
- `directory` 下拉菜单 → 保持常用目录不变
- `column_set` 布局 → 浏览按钮与输入框保持并排
- 浏览结果 → 在 column_set 后方插入新的 `select_static` 组件（`browse_result`）

## 替代方案

### 方案 B: 仅 input 输入框（无浏览）

只添加自定义路径 input 输入框，不做路径浏览功能。

**优点：** 实现简单，改动最小
**缺点：** 用户需要完全手动输入路径，无法探索服务器目录结构

### 方案 C: 多轮对话式导航

通过多条飞书消息逐步引导用户缩小目录范围（每次发一条新消息）。

**优点：** 不受卡片组件限制
**缺点：** 消息过多导致刷屏，体验碎片化

## 选择方案 A 的理由

方案 A 在用户体验和实现复杂度之间取得了平衡：
- 简单场景（选常用目录或直接输入路径）不需要浏览功能
- 复杂场景（不确定路径）可以通过浏览逐级定位
- 所有交互在一张卡片内完成，不会刷屏
