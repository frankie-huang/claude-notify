## Context

当前 `/new` 指令要求用户必须指定工作目录（通过 `--dir=` 参数或回复已有会话消息）。当用户忘记指定时，系统只能返回纯文本错误提示，用户体验不佳。

飞书卡片 2.0 支持多种交互式组件，包括：
- `input_select`: 下拉选择菜单
- `input_text`: 文本输入框
- `button`: 提交按钮
- `behaviors.callback`: 卡片回调交互

利用这些组件，我们可以构建一个更友好的目录选择界面。

## Goals / Non-Goals

### Goals
- 提供交互式目录选择卡片，提升用户体验
- 动态收集用户常用工作目录，减少输入负担
- 支持手动输入任意目录（不受历史限制）
- 提交成功后动态更新卡片状态

### Non-Goals
- 目录管理功能（如编辑、删除历史记录）
- 多目录批量选择
- 目录浏览/搜索功能（仅支持历史选择和手动输入）

## Decisions

### Decision 1: 常用目录收集机制

**方案**: 每次成功创建会话时记录目录使用，按 sender_id 分组统计使用频率。

**数据结构**:
```json
{
  "sender_id": {
    "/path/to/project1": {
      "count": 5,
      "last_used": 1704067200
    },
    "/path/to/project2": {
      "count": 3,
      "last_used": 1703980800
    }
  }
}
```

**排序规则**: 优先按使用次数降序，次数相同按最近使用时间降序。

**替代方案考虑**:
- 配置文件预定义: 灵活性差，需要用户手动维护
- 全局热门目录: 不考虑个人使用习惯，相关性弱

### Decision 2: 卡片组件设计

使用飞书 `input_select` 组件作为主要输入方式：
- `placeholder`: "选择或输入工作目录"
- `options`: 从常用目录列表动态生成
- `initial_option`: 默认选中最近使用的目录
- `value`: 用户最终选择的目录路径

搭配提交按钮：
- 按钮类型: `primary_filled`
- 按钮文本: "创建会话"
- `behaviors.type`: `callback`
- `value.action`: `select_dir`

### Decision 3: 卡片状态流转

```
初始状态 → (用户选择目录并点击提交) → 处理中 → (会话创建成功) → 成功状态
                                                             ↓
                                                        (失败) → 错误状态
```

- **初始状态**: 显示下拉菜单和提交按钮
- **成功状态**: 显示"会话已创建"+项目目录+session_id，移除按钮
- **错误状态**: 显示错误信息，保留输入组件（允许重新选择）

### Decision 4: 与现有 /new 流程的集成

**重要**: 飞书要求卡片回调在 3 秒内响应，但现有的 `/claude/new` 接口包含 2 秒启动检查，可能导致超时。

采用**异步创建模式**：
1. 用户点击按钮后，立即返回 toast 提示和"处理中"卡片状态（<500ms）
2. 后台线程异步执行会话创建逻辑
3. 创建完成后发送新的飞书消息通知结果

**优势**:
- 响应快速，不会超时
- 用户体验更好，立即得到反馈

**流程对比**:
```
同步模式（有风险）: 点击 → 2秒检查 → 返回结果
异步模式（安全）: 点击 → 立即返回"处理中" → 后台创建 → 新消息通知
```

## Risks / Trade-offs

### Risk 1: 卡片数据量限制

**风险**: 飞书卡片有数据大小限制，常用目录列表过长可能超出限制。

**缓解**:
- 限制最多显示 5 个常用目录
- 目录路径过长时进行截断显示
- 提供手动输入作为兜底

### Risk 2: 并发提交

**风险**: 用户可能重复点击提交按钮。

**缓解**:
- 提交后立即更新卡片为"处理中"状态
- 在卡片 value 中包含 timestamp 用于去重
- 服务端检查短时间内相同请求的重复提交

### Risk 3: 历史记录无限增长

**风险**: 长期使用可能导致历史记录文件过大。

**缓解**:
- 每个用户最多保留 20 条历史记录
- 超过 30 天未使用的目录自动清理
- 使用时按需清理过期数据

## Migration Plan

无需数据迁移，新功能为增量添加：
1. 历史记录文件首次使用时自动创建
2. 现有 `/new` 行为保持不变
3. 无目录参数时发送卡片而非错误文本（行为变更）

## Open Questions

无。
