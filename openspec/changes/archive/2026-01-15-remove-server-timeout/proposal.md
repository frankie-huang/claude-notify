# Proposal: Remove Server-Side Timeout

## Summary

移除回调服务器端的人为超时机制（REQUEST_TTL），让请求有效期完全由 Claude Code hook 的实际连接状态决定。用户在任何时候点击飞书按钮都能触达 Claude，只有当请求真正无法处理时才显示失效页面。

## Motivation

当前系统存在以下问题：

1. **服务器端有独立的超时计时（50秒）**：即使 Claude Code 还在等待响应，服务器也可能因为自己的超时而拒绝用户操作
2. **超时时间不一致**：客户端 socat 超时（55秒）与服务器 TTL（原60秒，后改50秒）不同步，导致用户体验差
3. **不必要的请求失效**：用户可能因为临时走开等原因响应较慢，但只要 Claude Code 还在等待，应该允许用户操作

## Desired Behavior

| 场景 | 当前行为 | 期望行为 |
|------|----------|----------|
| 用户在 50 秒后点击 | 显示"请求已过期" | 如果 socket 还连着，正常处理 |
| Claude Code hook 超时 | 服务器可能还认为有效 | 检测到 socket 断开，显示失效 |
| 用户重复点击 | 第二次显示错误 | 第二次显示"已被处理" |

## Approach

1. **移除 REQUEST_TTL 超时机制**：不再主动让请求过期
2. **依赖 socket 连接状态**：socket 连着 = 请求有效，socket 断了 = 请求失效
3. **移除清理线程**：不再需要定时清理过期请求
4. **改进错误提示**：区分"已被处理"和"连接已断开"

## Impact

- **正面**：用户响应窗口更灵活，体验更好
- **风险**：如果大量请求堆积且 socket 长时间不断开，可能占用内存（实际场景中不太可能）
- **缓解**：保留基于 socket 状态的清理机制，定期检查并移除已断开的连接

## Spec Deltas

- `permission-notify`: 修改超时处理相关的 requirements
