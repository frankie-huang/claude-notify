# 用户使用指南

本文档面向已完成部署的终端用户，介绍如何通过飞书与 Claude Code 机器人交互。

> 部署安装请参阅 [快速开始](../../QUICKSTART.md)。

---

## 两种使用模式

系统支持两种部署模式，功能范围不同：

| 特性 | Webhook 模式 | OpenAPI 模式 |
|------|-------------|-------------|
| 权限请求通知 | 支持 | 支持 |
| 完成事件通知 | 支持 | 支持 |
| 按钮交互 | 跳转浏览器 | 飞书内 toast 响应 |
| 回复消息继续会话 | 不支持 | 支持 |
| /new、/reply 指令 | 不支持 | 支持 |
| 群聊消息发送 | 不支持 | 支持 |

> Webhook 模式提供权限请求和完成事件的通知能力，但不支持指令交互和回复继续会话。以下章节中标注"仅 OpenAPI"的功能需要 OpenAPI 模式。

---

## 发起新会话（仅 OpenAPI）

### /new 指令

向机器人发送 `/new` 指令即可发起新的 Claude 会话。支持以下格式：

```
/new                                      # 弹出目录选择卡片
/new 帮我写一个排序算法                       # 弹出卡片，预填 prompt
/new --dir=/home/user/project 帮我修复 bug   # 直接指定目录和提示词
/new --cmd=1 --dir=/path prompt            # 指定 Command 索引
/new --cmd=opus --dir=/path prompt         # 按名称子串匹配 Command
```

- 当 `--dir` 和 prompt 齐全时，会话直接创建
- 缺少目录或 prompt 时，弹出**目录选择卡片**让你补充信息

### 目录选择卡片

卡片标题为"完善信息以创建会话"，包含以下表单：

1. **选择工作目录** — 从常用目录下拉框中选择，或点击"浏览"按钮浏览服务器目录
2. **自定义路径** — 直接输入完整路径（如 `/home/user/project`），右侧也有"浏览"按钮
3. **选择子目录** — 点击浏览后出现，可继续深入浏览子目录
4. **选择 Claude Command** — 仅在配置了多命令时显示
5. **输入提示词** — 多行文本框，描述你要 Claude 做的事情

**目录优先级**：选择子目录 > 自定义路径 > 常用目录

填写完成后点击"创建会话"按钮，卡片标题会变为"正在创建会话"，后台异步执行。

会话创建成功后你会收到确认消息，包含项目路径和 Session ID。

---

## 继续已有会话（仅 OpenAPI）

有三种方式继续一个已有的 Claude 会话：

### 方式一：直接回复飞书消息（推荐）

在飞书中**回复**机器人发送的任意消息（权限卡片、Stop 通知等），输入新的问题即可继续该会话。系统会自动查找消息对应的 session 并恢复上下文。

这是最简单直观的方式——像跟人聊天一样，回复消息就能继续对话。

### 方式二：/reply 指令

在回复消息时使用 `/reply` 指令，可以临时切换 Claude Command：

```
/reply --cmd=opus 请用更强的模型重新分析这个问题
/reply 继续上次的任务
```

> `/reply` **必须在回复消息时使用**，不能作为独立消息发送。它不支持 `--dir` 参数（目录由原始 session 决定）。

### 方式三：终端 claude --resume

从 Stop 通知卡片中复制 session_id，在终端执行：

```bash
claude --resume <session_id>
```

适用于需要在终端环境中直接操作的场景。

---

## 处理权限请求

Claude Code 在执行需要授权的操作时（如运行 Bash 命令、编辑文件），会发送权限请求卡片。

### 卡片内容

- **标题**："Claude Code 权限请求"
- **信息行**：项目名称、会话 ID（前 8 位）、时间戳
- **工具详情**：显示 Claude 想要执行的具体命令或操作内容
- **底部提示**："请尽快操作以避免 Claude 超时等待"

### 四个按钮

| 按钮 | 效果 |
|------|------|
| **批准运行** | 允许这一次执行，后续类似操作仍需授权 |
| **始终允许** | 允许执行并写入规则，后续同类操作自动通过 |
| **拒绝运行** | 拒绝本次操作，Claude 会尝试其他方式完成任务 |
| **拒绝并中断** | 拒绝并停止当前整个任务 |

### 模式差异

- **OpenAPI 模式**：点击按钮后飞书内直接显示 toast 反馈，体验流畅
- **Webhook 模式**：点击按钮会跳转浏览器页面完成确认
- **降级模式**（按钮不可用时）：需要在终端手动确认权限请求

---

## 查看任务结果

Claude Code 完成任务后，会发送 **Stop 通知卡片**。

### 卡片内容

- **标题**："Claude Code 处理完成 [session_id]"（标题包含 session_id 便于搜索）
- **提示**："Claude Code 已完成处理，请引用该消息继续话题"
- **信息行**：项目名、完整会话 ID、时间戳
- **答复区域**：灰色背景，显示 Claude 的响应内容摘要
- **思考过程**（可选）：可通过配置 `STOP_THINKING_MAX_LENGTH` 控制是否显示
- **底部恢复指令**：`claude --resume <session_id>`（可复制到终端使用）

> 引用（回复）Stop 通知卡片即可继续该会话。

---

## Claude Command 多命令切换

如果管理员配置了多个 Claude Command（如默认命令和 Opus 模型命令），你可以在使用时选择：

### 通过卡片选择

`/new` 弹出的目录选择卡片中会显示 Command 下拉框，直接选择即可。

### 通过参数指定

```
/new --cmd=0 --dir=/path prompt      # 按索引选择（从 0 开始）
/new --cmd=opus --dir=/path prompt   # 按名称子串匹配
/reply --cmd=opus prompt             # 回复时切换 Command
```

### Session Command 记忆

每个 session 会记忆最近使用的 Command。后续通过回复消息继续会话时，系统自动复用上次的 Command，无需每次指定。

---

## 群聊使用（仅 OpenAPI）

Claude 机器人支持在飞书群聊中使用。

### 与私聊的差异

- 群聊中需要 **@机器人** 或**回复机器人消息**才能触发交互
- 权限通知和 Stop 通知会发送到对应群聊中

### Session 与群聊映射

当你在群聊中回复消息继续会话时，系统会自动记录 session 与群聊的映射关系。后续该 session 的所有通知（权限请求、完成通知等）会自动发送到对应群聊，无需额外配置。

---

## 常见错误提示

| 场景 | 提示内容 | 解决方式 |
|------|---------|---------|
| /new 参数格式错误 | "参数格式错误，正确格式：'/new --dir=/path [--cmd=0] prompt'" | 检查参数格式，注意 `--dir=` 需要等号 |
| /reply 不在回复消息中使用 | "'/reply' 指令仅支持在回复消息时使用" | 先回复一条机器人消息，再输入 /reply |
| /reply 带了 --dir 参数 | "'/reply' 不支持 '--dir' 参数" | 去掉 `--dir` 参数，会话目录由原始 session 决定 |
| /reply 没有输入内容 | "请提供问题内容" | 在 /reply 后面补充你的问题 |
| 回复的消息找不到对应会话 | "无法找到对应的会话（可能已过期或被清理）" | 重新发起 `/new` 指令创建新会话 |
| 回复消息内容为空 | "消息内容为空，无法继续会话" | 输入文本内容后再发送 |
| 未知指令 | "未知指令：'/xxx'" | 仅支持 `/new` 和 `/reply` 指令 |
| 用户未注册 | "您尚未注册，无法使用此功能" | 联系管理员完成注册授权 |
| 目录或 prompt 为空 | toast 提示"请选择工作目录"或"请输入问题" | 补充缺失的信息后重新提交 |
| Claude 正在处理中 | "Claude 正在处理您的问题，请稍候..." | 等待当前任务完成后再发送新消息 |
| 服务未就绪 | "服务未就绪，请稍后重试" | 等待服务启动完成，或联系管理员检查服务状态 |
