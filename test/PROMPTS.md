# 权限请求测试指令集

本文档包含一系列用于测试 Claude Code 权限请求功能的指令。

## 使用方法

### 步骤 1：准备测试环境

在测试前，建议临时配置权限，让所有操作都能触发权限请求：

```bash
# 1. 备份当前配置
cp ~/.claude/settings.json ~/.claude/settings.json.bak

# 2. 编辑配置
# ~/.claude/settings.json:
{
  "permissions": {
    "allow": [],    // 清空，不允许自动通过
    "deny": [],     // 清空，不自动拒绝
    "ask": [        // 将这些工具加入询问列表
      "Bash",
      "Read",
      "Write",
      "Edit",
      "Grep",
      "Glob",
      "WebSearch",
      "WebFetch"
    ]
  }
}

# 3. 重启 Claude Code 使配置生效
```

> **为什么需要配置 `ask` 列表？**
>
> 某些工具（如 Grep、Glob、WebSearch、WebFetch）被 Claude Code 视为"只读安全工具"，默认不会触发权限请求。必须将它们加入 `ask` 列表才能测试这些工具的通知功能。

### 步骤 2：启动测试对话

根据需要选择以下提示词发送给 Claude：

#### 提示词 1：完整组合测试（推荐）

```
请阅读 test/PROMPTS.md，然后执行组合测试（全工具覆盖，幂等）。
```

#### 提示词 2：快速单个测试

```
请阅读 test/PROMPTS.md，然后依次执行单个快速测试中的指令。
```

#### 提示词 3：自定义测试

```
请依次执行以下测试。重要：即使某个测试被拒绝或失败，也请继续执行后续测试，不要中断。

1. 读取 /etc/hosts 文件
2. 查找所有 .py 文件
3. 搜索代码中的 TODO 关键字
4. 创建 ./test-permission.txt 文件
5. 在 ./test-permission.txt 中添加多行文本
6. 读取 ./test-permission.txt 文件
7. 删除 ./test-permission.txt 文件
8. 查看端口 8080 是否被占用
9. 查看网络连接状态 (netstat 或 ss)
10. 运行 npm --version
```

### 步骤 3：观察和验证

- 权限请求弹窗是否正确显示
- 飞书通知卡片是否收到
- 批准/拒绝操作是否正确执行

### 步骤 4：测试后恢复

测试完成后，记得恢复原有配置：

```bash
# 恢复备份的配置
cp ~/.claude/settings.json.bak ~/.claude/settings.json

# 重启 Claude Code
```

---

## 测试指令分类（高触发率）

### Bash 工具

| 类型 | 指令 |
|------|------|
| 包管理 | `运行 npm install` |
| 包管理 | `运行 npm run build` |
| 包管理 | `运行 pip install requests` |
| 网络 | `查看端口 8080 是否被占用 (lsof)` |
| 网络 | `查看网络连接状态 (netstat 或 ss)` |
| 网络 | `下载文件 (curl)` |
| 系统 | `查看进程列表 (ps aux)` |
| Git | `创建 git commit` |
| Git | `推送代码到远程 (git push)` |
| 文件 | `删除文件 (rm)` |

### 文件操作工具

| 类型 | 指令 |
|------|------|
| Read | `读取 /etc/hosts` |
| Read | `读取 .env 文件` |
| Read | `读取 .git/config` |
| Write | `创建配置文件` |
| Edit | `修改项目文件` |
| Glob | `查找所有 .py 文件` |
| Grep | `搜索 TODO 关键字` |

### 网络工具

| 类型 | 指令 |
|------|------|
| WebSearch | `搜索 Claude Code 文档` |
| WebFetch | `获取指定 URL 内容` |
| Task | `探索项目代码结构` |

---

## 快速测试

### 组合测试（全工具覆盖，幂等）

```
请依次执行以下测试。重要：即使某个测试被拒绝或失败，也请继续执行后续测试，不要中断。

1. 读取 /etc/hosts 文件
2. 查找所有 .py 文件
3. 搜索代码中的 TODO 关键字
4. 创建 ./test-permission.txt 文件
5. 在 ./test-permission.txt 中添加多行文本（包含 3-4 行内容）
6. 读取 ./test-permission.txt 文件
7. 删除 ./test-permission.txt 文件
8. 查看端口 8080 是否被占用 (lsof -i :8080)
9. 查看网络连接状态 (netstat 或 ss)
10. 运行 npm --version
```

**覆盖工具**：Read、Glob、Grep、Write、Edit、Bash(网络/包管理/删除)

**说明**：所有操作均为只读或对临时文件操作，执行完后不会留下变更。

---

## 单个快速测试

| 类型 | 快速指令 |
|------|----------|
| Read 系统 | `读取 /etc/hosts` |
| Read 配置 | `读取 .env 文件` |
| Glob | `查找所有 .py 文件` |
| Grep | `搜索 TODO 关键字` |
| Edit | `在 ./test-permission.txt 添加注释` |
| Write | `创建 ./test-permission.txt` |
| Bash 网络 | `查看端口 8080 是否被占用` |
| Bash 包管理 | `运行 npm install` |
| Bash Git | `创建 git commit` |
| Bash 系统 | `查看进程列表` |

---

## 复合场景测试

> **注意**：以下场景为非幂等测试，执行后会产生变更，请谨慎使用。

### 场景 1：项目初始化

```
请帮我初始化这个项目：
1. 读取 README.md 了解项目
2. 查看 .env 文件是否存在
3. 创建 .env 文件并添加配置
4. 运行 npm install 安装依赖
```

**预期触发权限**：Read, Read, Write, Bash

### 场景 2：代码提交

```
请帮我提交代码：
1. 查看 git status
2. 查看 git diff
3. 添加所有更改
4. 创建 commit
5. 推送到远程
```

**预期触发权限**：多个 Bash 命令

### 场景 3：系统诊断

```
请帮我诊断系统问题：
1. 查看内存使用情况
2. 查看磁盘使用情况
3. 查看网络连接状态
4. 查看进程列表
```

**预期触发权限**：多个 Bash 命令

### 场景 4：批量文件处理

```
请帮我处理项目文件：
1. 查找所有 .py 文件
2. 搜索代码中的 TODO 注释
3. 在找到的文件中添加注释
4. 创建处理日志文件
```

**预期触发权限**：Glob, Grep, Edit, Write

---

## 边界条件测试

### 超长命令

| 指令 | 说明 |
|------|------|
| `请运行一个非常长的命令...` | 测试命令截断显示 |

### 特殊字符

| 指令 | 说明 |
|------|------|
| `请运行 echo "test with \"quotes\""` | 测试引号转义 |
| `请运行 echo 'test with '\''single'\'' quotes'` | 测试单引号转义 |

### 敏感文件

| 指令 | 说明 |
|------|------|
| `请读取 ~/.ssh/id_rsa` | 测试敏感文件访问 |
| `请读取 /etc/passwd` | 测试系统文件访问 |
| `请读取 /etc/shadow` | 测试受保护文件 |

### 危险命令

| 指令 | 说明 |
|------|------|
| `请删除根目录下的所有文件` | 测试危险命令拦截 |
| `请运行 sudo su` | 测试权限提升拦截 |

---

## 验证清单

测试时请验证以下功能：

- [ ] 权限请求弹窗正确显示
- [ ] 弹窗中的命令/操作描述清晰准确
- [ ] 批准后操作正确执行
- [ ] 拒绝后操作被正确阻止
- [ ] "始终允许"后相同操作不再询问
- [ ] 飞书通知卡片正确发送
- [ ] 飞书按钮点击正常响应
- [ ] 回调服务未运行时回退到终端交互
- [ ] 超时后正确处理

---

## 注意事项

1. **危险命令**：边界条件测试包含危险命令，请谨慎批准
2. **系统文件**：某些测试涉及系统文件，可能需要额外权限
3. **环境依赖**：部分测试需要项目配置相应的工具（如 npm、python 等）
4. **回调服务**：测试飞书交互功能需确保回调服务正在运行

---

## 文档版本

- 创建日期：2025-01-21
- 更新日期：2025-01-21
- 版本：2.2.0
- 适用项目：claude-notify
